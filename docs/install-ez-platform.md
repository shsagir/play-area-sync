---

template:         article
reviewed:         2016-06-24
naviTitle:        eZ Platform
title:            Install eZ Platform on fortrabbit
lead:             Learn how to install and tune the eZ Platform on fortrabbit.

websiteLink:      http://ez.no/
websiteLinkText:  ez.no
category:         CMS
image:            ez-mark.png
version:          1.3
group:            Install_guides

dontList:   true

seeAlsoLinks:
    - app

keywords:
    - ez
    - ezplatform
    - platform
    - ezpublish
    - publish
    - symfony
    - cms
    - install

tags:
    - advanced
    - php
    - install

---

## Get ready

We assume you've already created a New App with fortrabbit which has the [MySQL](mysql) and [Memcache](memcache) components enabled. You also need a local [EZ Platform](https://github.com/ezsystems/ezplatform/blob/master/INSTALL.md) installation.


## Install

If you don't have one, you can setup a new one locally:

```bash
$ cd ~/Projects
$ composer create-project --prefer-dist --no-dev ezsystems/ezplatform MyApp "~1.4@dev"
$ cd MyApp
```

**Note**: The `@dev` is required, since 1.4 is still in development. The ezPublish Kernel package [had a bug](https://github.com/ezsystems/ezpublish-kernel/commit/5c754a346bad15435e9a29431fbb2d14f2419623) making it impossible to use S3 or S3 compatible storages before recently. This has been fixed in 1.4.

### Persistent storage

You most likely require a storage, for user uploads or content generated by your editors - or any other runtime data your App creates. You can use our [Object Storage Component](/object-storage) for that purpose. Once you have booked the Component in the Dashboard the credentials will automatically become available via the [App secrets](/secrets).

eZ Platform uses [Flysystem](https://github.com/thephpleague/flysystem) to handle the storage, so you need to install the [AWS PHP SDK](https://github.com/aws/aws-sdk-php) to use the S3 storage adapter:

```
$ composer require "aws/aws-sdk-php:2.*"
```

### Parameter config

Since you don't want any credentials in Git you need to create a PHP parameter file, which reads all credentials either from your [App's secrets](secrets) or [environment variables](env-vars). Create the `app/config/parameters_prod.php` with the following contents:

```php
$secrets = json_decode(file_get_contents($_SERVER['APP_SECRETS']), true);

// Database credentials
$container->setParameter('database_driver', 'pdo_mysql');
$container->setParameter('database_host', $secrets['MYSQL']['HOST']);
$container->setParameter('database_name', $secrets['MYSQL']['DATABASE']);
$container->setParameter('database_user', $secrets['MYSQL']['USER']);
$container->setParameter('database_password', $secrets['MYSQL']['PASSWORD']);

// Memcache session
$container->setParameter('session_expire', getenv('SESSION_EXPIRE') ?: 86400);
$container->setParameter('session_prefix', getenv('SESSION_PREFIX') ?: 'ez_');
$container->setParameter('memcache_host_1', $secrets['MEMCACHE']['HOST1']);
$container->setParameter('memcache_port_1', $secrets['MEMCACHE']['PORT1']);
if (isset($secrets['MEMCACHE']['HOST2'])) {
    $container->setParameter('memcache_host_2', $secrets['MEMCACHE']['HOST2']);
    $container->setParameter('memcache_port_2', $secrets['MEMCACHE']['PORT2']);
}

// Object Storage storage credentials
$container->setParameter('object_storage_key', $secrets['OBJECT_STORAGE']['KEY']);
$container->setParameter('object_storage_secret', $secrets['OBJECT_STORAGE']['SECRET']);
$container->setParameter('object_storage_region', $secrets['OBJECT_STORAGE']['REGION']);
$container->setParameter('object_storage_bucket', $secrets['OBJECT_STORAGE']['BUCKET']);
$container->setParameter('object_storage_endpoint', 'https://'. $secrets['OBJECT_STORAGE']['SERVER']);
$container->setParameter('object_storage_host', $secrets['OBJECT_STORAGE']['HOST']);
$container->setParameter('object_storage_prefix', getenv('OBJECT_STORAGE_PREFIX') ?: 'ez');


// Logging to error log
$container->setParameter('log_type', 'error_log');
```

**Note**: `app/config/parameters_prod.php` can be safely added to Git since it does not contain any actual credentials.

### General config

The general config must now include the previously created `parameters_prod.php` and further set up [Memcache](memcache) as the default session cache. Open up `app/config/config_prod.yml` and replace it with the following content:

```yaml
imports:
    - { resource: config.yml }
    - { resource: parameters_prod.php }
    - { resource: ezplatform_prod.yml }

monolog:
    handlers:
        main:
            type:         fingers_crossed
            action_level: critical
            handler:      nested
        nested:
            type:  %log_type%
            path:  %log_path%
            level: debug
        console:
            type:  console

framework:
    session:
        handler_id: session.handler.memcached

services:
    session.memcached:
        class: Memcached
        arguments:
            persistent_id: %session_prefix%
        calls:
            - [ addServer, [ %memcache_host_1%, %memcache_port_1% ]]
            # if you are using a Memcache Production plan (with two nodes):
            #- [ addServer, [ %memcache_host_2%, %memcache_port_2% ]]

    session.handler.memcached:
        class:     Symfony\Component\HttpFoundation\Session\Storage\Handler\MemcachedSessionHandler
        arguments: [@session.memcached, { prefix: %session_prefix%, expiretime: %session_expire% }]
```

### EZ platform config

Now it's time to set S3 via flysystem as the default I/O system for eZ and to change the stash cache engine to Memcache. Replace `app/config/ezplatform_prod.yml` with:

```yaml
imports:
    - { resource: ezplatform.yml }

ezpublish:
    system:
        default:
            io:
                metadata_handler: default
                binarydata_handler: default
                url_prefix: "https://%object_storage_host%/%object_storage_prefix%"
ez_io:
    metadata_handlers:
        default:
            flysystem:
                adapter: default
    binarydata_handlers:
        default:
            flysystem:
                adapter: default

oneup_flysystem:
    adapters:
        default:
            awss3:
                client: s3_client
                bucket: %object_storage_bucket%
                prefix: %object_storage_prefix%

stash:
    caches:
        default:
            drivers: [ Memcache ]
            inMemory: true
            registerDoctrineAdapter: false
            Memcache:
                prefix_key: cache_
                retry_timeout: 1
                servers:
                    - { server: %memcache_host_1%, port: %memcache_port_1%, weight: 1 }
                    # - { server: %memcache_host_2%, port: %memcache_port_2%, weight: 1 }

services:
    s3_client:
        class: Aws\S3\S3Client
        factory_class: Aws\S3\S3Client
        factory_method: factory
        arguments:
            -
                version: latest
                region: "%object_storage_region%"
                endpoint: "%object_storage_endpoint%"
                credentials:
                    key: "%object_storage_key%"
                    secret: "%object_storage_secret%"

```

### Dashboard settings

Once all config files are created visit the [Dashboard](dashboard) and go to App > Domains and set the document root of your domain(s) to `web`. Then head over to App > PHP and enable the `xsl` PHP extension. Lastly go to App > Environment variablles and add `SYMFONY_ENV=prod`.

### Initialize local database

Optional: If you started from scratch and don't have a local database yet, it's now time to create it. You might need to set you *local* database credentials in `app/config/parameters.yml` beforehand. Then run:

```bash
$ php app/console --env=dev ezplatform:install clean
```

### Deploy

You are nearly done. Since eZ uses `app.php` as the "index file", you need to make that clear to the web server by creating `web/.htaccess`:

```
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.*)$ app.php [QSA,L]
DirectoryIndex app.php
```

The last file to touch is the `.gitignore` file, from which you need to remove `composer.lock` and `/web/.htaccess` as well:

```
/vendor/
.php~
/nbproject/
/.idea/
/bin/behat
/bin/phpunit
/app/check.php
/app/SymfonyRequirements.php
/app/cache/
/app/logs/
/ezpublish_legacy
/app/config/parameters.yml
/app/bootstrap.php.cache
/web/index_treemenu.php
/web/index_rest.php
/web/index_cluster.php
/web/bundles/
/web/css/
/web/js/
/web/design
/web/extension
/web/share
/web/var
#/web/.htaccess      << commented out
composer.phar
#composer.lock       << commented out
.buildpath
.project
.settings/
behat.yml
.php_cs.cache
```

That's about it. If your local project director is not already a Git repo, then you should make it now so:

```bash
# optional:
$ git init .

# connect with your App's remote
$ git remote add fortrabbit {{ssh-user}}@deploy.{{region}}.frbit.com:{{app-name}}.git

# add all to git and push
$ git add -A
$ git commit -m 'Initial'
$ git push -u fortrabbit master
```

**Note**: Your first deploy takes a long time, because all composer packages need to be installed. Subsequent deployments won't need to do that and will be much faster.

### Initialize database on fortrabbit

The last step is to initialize the database remotely. You can use a [remote SSH execution](/remote-ssh-execution) to do this:

``` bash
ssh {{ssh-user}}@deploy.{{region}}.frbit.com php app/console --env=prod ezplatform:install clean
```

**Note**: Using remote SSH execution, you can run all `app/console` commands.

Done.


## Troubleshooting

If something goes awry..

### You are getting a 403

Check your `.gitignore` file: You probably forgot to comment out the `/web/.htaccess` entry, which set's `app.php` as the directory index.
